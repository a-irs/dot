#compdef psh
#autoload

_psh () {
	local cmd
	if (( CURRENT > 2)); then
		cmd=${words[2]}
		curcontext="${curcontext%:*:*}:psh-$cmd"
		(( CURRENT-- ))
		shift words
		case "${cmd}" in
			rm|show|edit|mv|ls)
				_pass_complete_entries
				;;
		esac
	else
		local -a subcommands
		subcommands=(
			"show:Decrypt and print a store"
			"new:Set up a new store"
			"edit:Edit a store with $EDITOR"
			"mv:Rename the store"
			"rm:Remove store"
            "ls:List all stores"
		)
		_describe -t commands 'psh' subcommands
	fi
}

_pass_complete_entries () {
	local IFS=$'\n'
	local prefix="${PASSWORD_STORE_DIR:-$HOME/doc/psh-store}"
	_values -C 'passwords' $(find -L "$prefix" | sed -e "s#${prefix}/\{0,1\}##" | sort)
}
