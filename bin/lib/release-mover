#!/usr/bin/env bash

set -u

release=$(basename "$1")
release=${release// /.}
category=$2

y() { printf "$(tput setaf 3)%s$(tput sgr0)\n" "$@"; }

get_name() { printf "%s\n" "$release" | grep -oP '^.*?((19|20)[0-9]{2}|German|S[0-9][0-9]E[0-9][0-9])' | head -1 | rev | cut -d. -f 2- | rev | tr '.' ' '; }

get_year() { printf "%s\n" "$release" | grep -oP '(19|20)[0-9]{2}' | head -1; }

get_year_tv() {
    y=("/media/data/videos/tv/${1}"*)
    printf "%s\n" "$y" | grep -oP '(19|20)[0-9]{2}' | head -1
}

get_metadata() {
    name=$(get_name)
    name_length=${#name}
    printf "%s\n" "$release" | cut -c "$((name_length + 1))"-
}
metadata=$(get_metadata)

get_group() { printf "%s\n" "${metadata##*-}"; }

get_video_format() { printf "%s\n" "$metadata" | grep -ioP 'Xvid|DivX|x264|x265|HEVC' | head -1; }

get_video_size() {
    o=$(printf "%s\n" "$metadata" | grep -ioP '480p|720i|720p|1080i|1080p' | head -1)
    [[ ! "$o" ]] && o=480p
    printf "%s\n" "$o"
}

get_audio_format() { printf "%s\n" "$metadata" | grep -oP 'DTS|AAC|DD2\.0|AC3|FLAC|6CH' | head -1; }

get_source() { printf "%s\n" "$metadata" | grep -oiP 'BluRay|BDRip|DVDRip|BRRip|HDRip|Blu-ray|DVD-Rip|WEBRip|WEB-DL|HDTV'; }

get_season() { printf "%s\n" "$metadata" | grep -oP 'S[0-9][0-9]'; }

get_episode() { printf "%s\n" "$metadata" | grep -oP 'E[0-9][0-9]'; }

get_languages() {
    langs=""
    if echo "$metadata" | grep -oP '\.German.*\.DL\.' > /dev/null 2>&1; then
        langs=DE,EN
    elif echo "$metadata" | grep -oP '\.German\.' > /dev/null 2>&1; then
        langs=DE
    else
        langs=EN
    fi
    echo "$langs"
}

name_prefix() {
    prefixes=(Der Die Das Ein Eine The A An)
    for p in ${prefixes[@]}; do
        if [[ "$1" == "$p "* ]]; then
            printf "%s\n" "${1/$p /}, $p"
            return
        fi
    done
    printf "%s\n" "$1"
}

first() {
    f=${1:0:1}
    f=${f^^}
    case "$f" in
        [0-9]) f=0 ;;
    esac
    printf "%s\n" "$f"
}

em() {
    echo ""
    echo "$(tput setaf 2;tput bold)$@$(tput sgr0;tput init)"
}

# printf "%s: %s\n" "Release" "$release"
# printf "%s: %s\n" "Metadata" "$(get_metadata)"
# printf "%s: %s\n" "Group" "$(get_group)"
# printf "%s: %s\n" "Name" "$(get_name)"
# printf "%s: %s\n" "Year" "$(get_year)"
# printf "%s: %s\n" "Size" "$(get_video_size)"
# printf "%s: %s\n" "Video" "$(get_video_format)"
# printf "%s: %s\n" "Audio" "$(get_audio_format)"
# printf "%s: %s\n" "Source" "$(get_source)"
# printf "%s: %s\n" "Languages" "$(get_languages)"
# printf "\n%s: %s\n" "Season" "$(get_season)"
# printf "%s: %s\n" "Episode" "$(get_episode)"
# printf "\n"

if [[ $category == movies ]]; then

    DEST=/media/data/videos/movies

    read -er -i "$release"          -p "$(y 'Release:  ')" RELEASE
    read -er -i "$(get_name)"       -p "$(y 'Movie:    ')" NAME
    read -er -i "$(get_year)"       -p "$(y 'Year:     ')" YEAR
    read -er -i "$(get_languages)"  -p "$(y 'Langs:    ')" LANGS
    read -er -i "$(get_video_size)" -p "$(y 'Size:     ')" SIZE
    read -er -i "$(get_source)"     -p "$(y 'Source:   ')" SOURCE

    folder="$(first "$(name_prefix "$NAME")")/$(name_prefix "$NAME") ($YEAR) [$LANGS] [$SIZE $SOURCE]"

    em ":: make destination folder"
    mkdir -pv "$DEST/$folder"

    em ":: remove unneeded files"
    rm -rvf -- "$1"/proof "$1"/Proof "$1"/sample "$1"/Sample "$1"/*-sample.* "$1"/*-Sample.* "$1"/*-proof.* "$1"/*-Proof.* "$1"/*.nzb "$1"/*.url "$1"/*.srr "$1"/*.srs 2> /dev/null
    rm -rvf -- "$1"/*/proof "$1"/*/Proof "$1"/*/sample "$1"/*/Sample "$1"/*/*-sample.* "$1"/*/*-Sample.* "$1"/*/*-proof.* "$1"/*/*-Proof.* "$1"/*/*.nzb "$1"/*/*.url "$1"/*/*.srr "$1"/*/*.srs 2> /dev/null

    em ":: move video file"
    mv -v -- "$1"/*/*.mkv "$DEST/$folder/$NAME.mkv" 2> /dev/null
    mv -v -- "$1"/*.mkv "$DEST/$folder/$NAME.mkv" 2> /dev/null
    mv -v -- "$1"/*/*.avi "$DEST/$folder/$NAME.avi" 2> /dev/null
    mv -v -- "$1"/*.avi "$DEST/$folder/$NAME.avi" 2> /dev/null
    mv -v -- "$1"/*/*.mp4 "$DEST/$folder/$NAME.mp4" 2> /dev/null
    mv -v -- "$1"/*.mp4 "$DEST/$folder/$NAME.mp4" 2> /dev/null
    mv -v -- "$1"/*/*.m4v "$DEST/$folder/$NAME.m4v" 2> /dev/null
    mv -v -- "$1"/*.m4v "$DEST/$folder/$NAME.m4v" 2> /dev/null

    em ":: create nfo"
    mv -vf -- "$1"/*/*.nfo "$DEST/$folder/#$release" 2> /dev/null
    mv -vf -- "$1"/*.nfo "$DEST/$folder/#$release" 2> /dev/null
    touch "$DEST/$folder/#$release" 2> /dev/null

    em ":: delete empty folder"
    rmdir -pv "$1"/*/ 2> /dev/null
    rmdir -pv "$1" 2> /dev/null

    em "→ '$DEST/$folder'"
    find "$DEST/$folder"
fi

if [[ $category == tv ]]; then

    DEST=/media/data/videos/tv

    read -er -i "$release"          -p "$(y 'Release:  ')" RELEASE
    read -er -i "$(get_name)"       -p "$(y 'Series:   ')" NAME
    read -er -i "$(get_year_tv "$NAME")" -p "$(y 'Year:     ')" YEAR
    read -er -i "$(get_languages)"  -p "$(y 'Langs:    ')" LANGS
    read -er -i "$(get_video_size)" -p "$(y 'Size:     ')" SIZE
    read -er -i "$(get_source)"     -p "$(y 'Source:   ')" SOURCE
    read -er -i "$(get_season)"     -p "$(y 'Season:   ')" SEASON
    read -er -i "$(get_episode)"    -p "$(y 'Episode:  ')" EPISODE

    folder="$(name_prefix "$NAME") ($YEAR)/$SEASON [$LANGS] [$SIZE $SOURCE]"

    em ":: make destination folder"
    mkdir -pv "$DEST/$folder"

    em ":: remove unneeded files"
    rm -rvf -- "$1"/proof "$1"/Proof "$1"/sample "$1"/Sample "$1"/*-sample.* "$1"/*-Sample.* "$1"/*-proof.* "$1"/*-Proof.* "$1"/*.nzb "$1"/*.url "$1"/*.srr "$1"/*.srs 2> /dev/null
    rm -rvf -- "$1"/*/proof "$1"/*/Proof "$1"/*/sample "$1"/*/Sample "$1"/*/*-sample.* "$1"/*/*-Sample.* "$1"/*/*-proof.* "$1"/*/*-Proof.* "$1"/*/*.nzb "$1"/*/*.url "$1"/*/*.srr "$1"/*/*.srs 2> /dev/null

    em ":: move video file"
    NAME="$SEASON.$EPISODE"
    mv -v -- "$1"/*/*.mkv "$DEST/$folder/$NAME.mkv" 2> /dev/null
    mv -v -- "$1"/*.mkv "$DEST/$folder/$NAME.mkv" 2> /dev/null
    mv -v -- "$1"/*/*.avi "$DEST/$folder/$NAME.avi" 2> /dev/null
    mv -v -- "$1"/*.avi "$DEST/$folder/$NAME.avi" 2> /dev/null
    mv -v -- "$1"/*/*.mp4 "$DEST/$folder/$NAME.mp4" 2> /dev/null
    mv -v -- "$1"/*.mp4 "$DEST/$folder/$NAME.mp4" 2> /dev/null
    mv -v -- "$1"/*/*.m4v "$DEST/$folder/$NAME.m4v" 2> /dev/null
    mv -v -- "$1"/*.m4v "$DEST/$folder/$NAME.m4v" 2> /dev/null

    em ":: create nfo"
    mv -vf -- "$1"/*/*.nfo "$DEST/$folder/#$release" 2> /dev/null
    mv -vf -- "$1"/*.nfo "$DEST/$folder/#$release" 2> /dev/null
    touch "$DEST/$folder/#$release" 2> /dev/null

    em ":: delete empty folder"
    rmdir -pv "$1"/*/ 2> /dev/null
    rmdir -pv "$1" 2> /dev/null

    em "→ '$DEST/$folder'"
    find "$DEST/$folder"
fi

