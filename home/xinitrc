#!/usr/bin/env bash

if [ -d /etc/X11/xinit/xinitrc.d ]; then
    for f in /etc/X11/xinit/xinitrc.d/*; do
        source "$f"
    done
    unset f
fi

# keyboard
setxkbmap -option caps:escape &
xset r rate 200 30 &

[[ -f ~/.Xresources ]] && xrdb -merge ~/.Xresources &

xset s 0 0 &
# turn off after 5m
xset dpms 300 300 300 &

# applications
nitrogen --restore &
lxpolkit &
picom &
[[ $HOSTNAME == x1 ]] && xcalib ~/.config/x1carbon3rd_notebookcheck.com.icc &
redshift &

mkdir -p ~/.local/share/yay && ln -sfn ~/.local/share/yay ~/.cache/yay
mkdir -p ~/.local/share/thumbnails && ln -sfn ~/.local/share/thumbnails ~/.cache/thumbnails
mkdir -p ~/.local/share/thumbnails/darktable && ln -sfn ~/.local/share/thumbnails/darktable ~/.cache/darktable

~/.bin/workstats &

start-pulseaudio-x11 &

# wait for internet, then launch dropbox
nohup bash -c "if $HOME/.bin/wait-for-host dropbox.com; then dropbox; fi" < /dev/null &> /dev/null &

if [[ $HOSTNAME == x1 || $HOSTNAME == dell ]]; then
    xset s 120 120 &
    # turn off after 5m
    xset dpms 300 300 300 &
    xss-lock --transfer-sleep-lock -n "notify-send -i /usr/share/icons/Faba/48x48/actions/system-lock-screen.svg -- locking" -- ~/.bin/lock &
fi

if [[ $HOSTNAME == desk ]]; then
    numlockx &
    pulseeffects --gapplication-service &

    cat << 'EOF' | bash &
    set -e

    PATH=$HOME/.bin:$PATH

    wait-for-host spotify.com
    pidof spotify || exo-open "$HOME/.local/share/applications/spotify.desktop"
    xdotool set_desktop_for_window "$(xdotool search --limit 1 --sync --name "^Spotify Premium$")" 5

    wait-for-host srv1.home
    pidof kodi-x11 || exo-open "/usr/share/applications/kodi.desktop"
    xdotool set_desktop_for_window "$(xdotool search --limit 1 --sync --class "kodi")" 6
EOF

    if ! mount | grep -q "root@srv1.home:/media/data"; then
        bash -c "$HOME/.bin/wait-for-host srv1.home && sshfs root@srv1.home:/media/data /media/data -o reconnect -o BatchMode=yes -o allow_other" &
    fi

fi

dunst &
exec awesome
