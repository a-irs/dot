#!/usr/bin/env bash

DIR=~/doc/ctf/_docker/remnux
if [[ "$1" == pwd ]]; then
    shift
    WORK="$PWD"
else
    WORK=~/doc/ctf/"$(date +%Y-%m-%d)"
fi

set -euo pipefail

if [[ $# -eq 1 && $1 == build ]]; then
    shift
    cd "$DIR"
    docker build "$@" -t remnux .
    exit
fi

# make sure all files + directories for mounting exist
[[ ! -e "$WORK" ]] && mkdir -p "$WORK"
[[ ! -f "$DIR/shell.history" ]] && touch "$DIR/shell.history"
[[ ! -f "$DIR/shell.conf" ]] && touch "$DIR/shell.conf"

args=(
    # share shell history + config
    -v "$DIR/shell.history:/root/.bash_history"
    -v "$DIR/shell.conf:/root/.bashrc"

    # share working directory for today
    -v "$WORK:/work" -w /work
)

docker run -h remnux -it --rm "${args[@]}" remnux "$@"
rmdir "$WORK" 2>/dev/null || true
