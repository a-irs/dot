#!/bin/sh
# ref: https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh#L485

# minify (remove comments, remove blank lines, remove whitespace at beginning of line), then base64 and print deploy string
if [ "$1" = base64 ]; then
    echo "sh -c 'echo $(tail -n +10 "$0" | sed -e '/^[ \t]*#/d' | sed '/^$/d' | sed -e 's/^[ \t]*//' | base64) | base64 -d | sh'" | tr -d '\n'
    printf '\n'
    exit
fi
###################################################################

set -x

main() {
    w
    id
    uname -a
    cat /proc/version
    cat /etc/*-release
    cat /proc/cmdline
    lastlog | grep -v "Never logged in"
    for i in $(cut -d: -f1 /etc/passwd); do
        id "$i"
        # interesting groups: adm, wheel, sudo, ...
    done
    env

    echo ''

    # owned by any of my groups
    for g in $(groups); do
        find / -group "$g" ! -type l \
        ! -path "$HOME/*" \
        ! -path "/run/user/$(id -u)/*" \
        ! -path "/sys/fs/cgroup/systemd/user.slice/user-$(id -u).slice/*" \
        ! -path "/sys/fs/cgroup/unified/user.slice/user-$(id -u).slice/*" \
        ! -path "/proc/*" \
        ! -path "/sys/fs/cgroup/memory/*" \
        ! -path /dev/full \
        ! -path /dev/mqueue \
        ! -path /dev/null \
        ! -path /dev/pts/ptmx \
        ! -path /dev/random \
        ! -path /dev/shm \
        ! -path /dev/tty \
        ! -path /dev/urandom \
        ! -path /dev/zero \
        -ls 2>/dev/null
    done

    # SUID
    find / -perm -4000 \
        ! -path "/snap/*" \
        ! -path "*bin/firejail" \
        ! -path "*bin/chage" \
        ! -path "*bin/expiry" \
        ! -path "*bin/pkexec" \
        ! -path "*bin/mount" \
        ! -path "*bin/mount" \
        ! -path "*bin/ksu" \
        ! -path "*bin/fusermount" \
        ! -path "*bin/fusermount3" \
        ! -path "*bin/su" \
        ! -path "*bin/umount" \
        ! -path "*bin/chfn" \
        ! -path "*bin/chsh" \
        ! -path "*bin/gpasswd" \
        ! -path "*bin/newgrp" \
        ! -path "*bin/passwd" \
        ! -path "*bin/sudo" \
        ! -path "*bin/ping" \
        ! -path "*bin/at" \
        ! -path "/usr/lib/*ssh/ssh-keysign" \
        ! -path "/usr/lib/chromium/chrome-sandbox" \
        ! -path "/usr/lib/virtualbox/*" \
        ! -path "/usr/lib/qemu/qemu-bridge-helper" \
        ! -path "/usr/lib/Xorg.wrap" \
        -ls 2>/dev/null
    echo ''

    # writable files outside of home
    find / -writable ! -type l \
        ! -path "$HOME/*" \
        ! -path "/run/user/$(id -u)/*" \
        ! -path "/sys/fs/cgroup/systemd/user.slice/user-$(id -u).slice/*" \
        ! -path "/sys/fs/cgroup/unified/user.slice/user-$(id -u).slice/*" \
        ! -path "/proc/*" \
        ! -path "/sys/fs/cgroup/memory/*" \
        ! -path /dev/full \
        ! -path /dev/mqueue \
        ! -path /dev/null \
        ! -path /dev/pts/ptmx \
        ! -path /dev/random \
        ! -path /dev/shm \
        ! -path /dev/tty \
        ! -path /dev/urandom \
        ! -path /dev/zero \
        -ls 2>/dev/null
    echo ''

    # readable sensitive files (outside of home) #1
    find / \( \
        -name "id_dsa*" -o \
        -name "id_rsa*" -o \
        -name "id_ecdsa*" -o \
        -name "id_ed25519*" -o \
        -name "authorized_hosts" -o \
        -name "authorized_keys" \
        \) -ls 2>/dev/null
    echo ''

    # readable sensitive files #2
    for x in /etc/shadow /etc/sudoers* /home/* /root /var/mail/*; do
        test -r "$x" && echo "$x"
    done
    find /var/mail -type f

    # jump, find creds, ...
    # -name "known_hosts" -o \
    #     *_history
    #
    # interesting
    # /etc/ssh/sshd_config
    # # cron
    # find /etc /var -name "cron*" -ls 2>/dev/null
    # find /etc /var -name "anacron*" -ls 2>/dev/null
    # systemctl list-timers --all

    # writeable PATHs
    for x in $(echo "$PATH" | tr ":" " "); do
        test -w "$x" && echo "$x"
    done

    #sudo -l
    # try sudo without password
    echo '' | sudo -S -l -k 2>/dev/null

    # https://gtfobins.github.io
}
main
