#!/bin/sh
# ref: https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh#L485, https://gtfobins.github.io

# minify (remove comment lines, remove blank lines, remove whitespace at beginning of line), then base64 and print deploy string
if [ "$1" = base64 ]; then
    echo "sh -c 'echo $(tail -n +10 "$0" | sed -E '/^[ ]*#/d' | sed -E '/^$/d' | sed -E 's/^[ ]*//' | base64) | base64 -d | sh'" | tr -d '\n'
    printf '\n'
    exit
fi
###################################################################

log() {
    color=$1 && shift
    text=$*
    printf '\n%s\n\n' "$(tput setaf "$color")############# $text$(tput sgr0)"
}

main() {
    uid=$(id -u)

    log 2 "system info"

    w
    id
    uname -a
    cat /proc/version
    cat /etc/*-release
    cat /proc/cmdline
    lastlog | grep -v "Never logged in"
    for i in $(cut -d: -f1 /etc/passwd); do
        id "$i"
        # interesting groups: adm, wheel, sudo, ...
    done
    env

    echo ''

    log 2 "files or directories owned by my groups"
    for g in $(groups); do
        find / -group "$g" ! -type l \
        ! -path "$HOME/*" \
        ! -path "/run/user/$uid/*" \
        ! -path "/sys/fs/cgroup/systemd/user.slice/user-$uid.slice/*" \
        ! -path "/sys/fs/cgroup/unified/user.slice/user-$uid.slice/*" \
        ! -path "/proc/*" \
        ! -path "/sys/fs/cgroup/memory/*" \
        ! -path /dev/full \
        ! -path /dev/mqueue \
        ! -path /dev/null \
        ! -path /dev/pts/ptmx \
        ! -path /dev/random \
        ! -path /dev/shm \
        ! -path /dev/tty \
        ! -path /dev/urandom \
        ! -path /dev/zero \
        -ls 2>/dev/null
    done

    log 2 "SUID"
    find / -perm -4000 \
        ! -path "*bin/at" \
        ! -path "*bin/chage" \
        ! -path "*bin/chfn" \
        ! -path "*bin/chsh" \
        ! -path "*bin/expiry" \
        ! -path "*bin/firejail" \
        ! -path "*bin/fusermount" \
        ! -path "*bin/fusermount3" \
        ! -path "*bin/gpasswd" \
        ! -path "*bin/ksu" \
        ! -path "*bin/mount" \
        ! -path "*bin/mount" \
        ! -path "*bin/newgidmap" \
        ! -path "*bin/newgrp" \
        ! -path "*bin/newuidmap" \
        ! -path "*bin/passwd" \
        ! -path "*bin/ping" \
        ! -path "*bin/pkexec" \
        ! -path "*bin/su" \
        ! -path "*bin/sudo" \
        ! -path "*bin/traceroute6.iputils" \
        ! -path "*bin/umount" \
        ! -path "*bin/vmware-user-suid-wrapper" \
        ! -path "*lib/*ssh/ssh-keysign" \
        ! -path "*lib/Xorg.wrap" \
        ! -path "*lib/chromium/chrome-sandbox" \
        ! -path "*lib/dbus-1.0/dbus-daemon-launch-helper" \
        ! -path "*lib/eject/dmcrypt-get-device" \
        ! -path "*lib/policykit-1/polkit-agent-helper-1" \
        ! -path "*lib/qemu/qemu-bridge-helper" \
        ! -path "*lib/snapd/snap-confine" \
        ! -path "*lib/virtualbox/*" \
        ! -path "*lib/x86_64-linux-gnu/lxc/lxc-user-nic" \
        ! -path "*lib/xorg/Xorg.wrap" \
        ! -path "/snap/*" \
        -ls 2>/dev/null
    echo ''

    log 1 "writable files outside of \$HOME"
    find / -writable ! -type l \
        ! -path "$HOME/*" \
        ! -path "/run/user/$uid/*" \
        ! -path "/sys/fs/cgroup/systemd/user.slice/user-$uid.slice/*" \
        ! -path "/sys/fs/cgroup/unified/user.slice/user-$uid.slice/*" \
        ! -path "/proc/*" \
        ! -path "/sys/fs/cgroup/memory/*" \
        ! -path /dev/full \
        ! -path /dev/mqueue \
        ! -path /dev/null \
        ! -path /dev/pts/ptmx \
        ! -path /dev/random \
        ! -path /dev/shm \
        ! -path /dev/tty \
        ! -path /dev/urandom \
        ! -path /dev/zero \
        -ls 2>/dev/null
    echo ''

    # log 1 "sensitive files outside of \$HOME"
    # find / \( \
    #     -name "id_dsa*" -o \
    #     -name "id_rsa*" -o \
    #     -name "id_ecdsa*" -o \
    #     -name "id_ed25519*" -o \
    #     -name "authorized_hosts" -o \
    #     -name "authorized_keys" -o \
    #     -name "db.php" -o \
    #     -name "config.php" -o \
    #     -name "users.php" \) \
    #     -ls 2>/dev/null
    # echo ''

    log 1 "readable sensitive files (outside of \$HOME)"
    for x in /etc/shadow /etc/sudoers* /home/* /root /var/mail/* $(find /var/mail -type f); do
        test -r "$x" && echo "$x"
    done

    # files in /usr/local/bin /usr/local/sbin
    # jump, find creds, ...
    # -name "known_hosts" -o \
    #     *_history
    #
    # interesting
    # /etc/ssh/sshd_config
    # # cron
    # find /etc /var -name "cron*" -ls 2>/dev/null
    # find /etc /var -name "anacron*" -ls 2>/dev/null
    # systemctl list-timers --all

    log 1 "writeable \$PATHs"
    for x in $(echo "$PATH" | tr ":" " "); do
        test -w "$x" && echo "$x"
    done

    log 1 "sudo"
    echo '' | sudo -S -l -k 2>/dev/null
    sudo -l
}

main
