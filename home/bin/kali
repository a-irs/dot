#!/usr/bin/env bash

WORK=~/doc/ctf/"$(date +%Y-%m-%d)"
DIR=~/doc/ctf/_docker/kali

set -euo pipefail

if [[ $# -eq 1 && $1 == build ]]; then
    shift
    cd "$DIR"
    docker build "$@" -t kali .
    exit
fi

# make sure all files + directories for mounting exist
[[ ! -e "$WORK" ]] && mkdir -p "$WORK"
[[ ! -f "$DIR/shell.history" ]] && touch "$DIR/shell.history"
[[ ! -f "$DIR/shell.conf" ]] && touch "$DIR/shell.conf"

args=(
    # share shell history + config
    -v "$DIR/shell.history:/root/.bash_history"
    -v "$DIR/shell.conf:/root/.bashrc"

    # share working directory for today
    -v "$WORK:/work" -w /work
)

if [[ "$(uname)" == Linux ]]; then
    args+=(
        # GPU support (e.g. for hashcat)
        --device /dev/dri --device /dev/vga_arbiter

        # X11 forwarding via socket
        # -v /tmp/.x11-unix:/tmp/.x11-unix -e DISPLAY="unix$DISPLAY"
    )
fi

# TODO test
if [[ $# -eq 1 && $1 == rev* ]]; then
    args+=(
        # port forwarding (e.g. for http server, reverse shell catching, ...)
        -p 4444:4444 -p 9000:9000
    )

    read -r -p "Setup reverse shell on ports 4444 and 9000, this stops the firewall and restarts docker. Are you sure? (y/N) " -n1
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        sudo systemctl stop iptables.service
        sudo systemctl restart docker
    else
        exit 1
    fi
fi

docker run -h kali -it --rm "${args[@]}" kali "$@"
rmdir "$WORK" 2>/dev/null || true
