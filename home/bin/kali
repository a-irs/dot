#!/usr/bin/env bash

WORK=~/doc/ctf/"$(date +%Y-%m-%d)"
DIR=~/doc/ctf/_docker/kali

set -euo pipefail

hostname=kali

if [[ $# -gt 0 && $1 == build ]]; then
    shift
    cd "$DIR"
    docker build "$@" -t kali .
    exit
fi

# make sure all files + directories for mounting exist
[[ ! -e "$WORK" ]] && mkdir -p "$WORK"
[[ ! -f "$DIR/shell.history" ]] && touch "$DIR/shell.history"
[[ ! -f "$DIR/shell.conf" ]] && touch "$DIR/shell.conf"

args=(
    # share shell history + config
    -v "$DIR/shell.history:/root/.bash_history"
    -v "$DIR/shell.conf:/root/.bashrc"

    # share working directory for today
    -v "$WORK:/work" -w /work
)

if [[ "$(uname)" == Linux ]]; then
    args+=(
        # GPU support (e.g. for hashcat)
        --device /dev/dri --device /dev/vga_arbiter

        # X11 forwarding via socket
        # -v /tmp/.x11-unix:/tmp/.x11-unix -e DISPLAY="unix$DISPLAY"
    )
fi

if [[ $# -gt 0 && $1 == rev* ]]; then
    shift
    port=$(shuf -i 4444-9000 -n 1)  # random port in range
    args+=(
        # port forwarding (e.g. for http server, reverse shell catching, ...)
        -p "0.0.0.0:$port:$port"
    )
    hostname=kali:$port
fi

docker run -h "$hostname" -it --rm "${args[@]}" kali "$@"
rmdir "$WORK" 2>/dev/null || true
