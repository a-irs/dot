#!/usr/bin/env python3

# TODO: if run without args: simply show last results again

import sys
import json
from pathlib import Path
import subprocess
import itertools
from dataclasses import dataclass


OUT_FILE = Path.home() / ".oo"

class Color(object):
    RESET = '\033[' + str(0) + 'm'
    BOLD = '\033[' + str(1) + 'm'
    DIM = '\033[' + str(2) + 'm'
    MAGENTA = '\033[' + str(35) + 'm'
    CYAN = '\033[' + str(36) + 'm'
    BLUE = '\033[' + str(34) + 'm'
    GREEN = '\033[' + str(32) + 'm'
    YELLOW = '\033[' + str(33) + 'm'
    RED = '\033[' + str(31) + 'm'
    WHITE = '\033[' + str(37) + 'm'
    BLACK = '\033[' + str(30) + 'm'


def run_rg(args: "list[str]") -> subprocess.CompletedProcess:
    base_args = ["rg", "--case-sensitive", "--with-filename", "--line-number", "--heading", "--json", "--sort=path"]
    return subprocess.run(base_args + args, capture_output=True, text=True)


def truncate(s: str, limit=1000) -> str:
    if len(s) > limit:
        s = s[0:limit] + Color.MAGENTA + " ... [truncated]" + Color.RESET
    return s

@dataclass
class SearchMatch:
    line_nr: int
    text: str
    file_name: str
    hint: str = ""

def main():

    process = run_rg(sys.argv[1:])
    lines = [l for l in process.stdout.split("\n") if l]

    if lines:
        # empty out the file
        open(OUT_FILE, "w").close()

    matches = []
    line_width = 0

    i = 0
    hints = list(itertools.product("dfghjertzuicvbasklqwopyxnm", repeat=1)) + list(itertools.product("dfghjertzuicvbasklqwopyxnm", repeat=2))

    for line in lines:
        try:
            j = json.loads(line)
        except json.decoder.JSONDecodeError:
            print(line)
            continue

        if j.get("type") == "begin":
            if i != 0:
                print()
            s = "{}{}{}".format(Color.BOLD + Color.BLUE, j["data"]["path"]["text"], Color.RESET)
            print(s)

            # reset state values
            matches = []
            line_width = 0

        elif j.get("type") == "match":
            d = j["data"]
            text = d["lines"]["text"]

            # replace going back to front (so start/end positions do not change while inserting ANSI codes)
            for submatch in sorted(d["submatches"], key=lambda d: d["end"], reverse=True):
                text = "{}{}{}{}{}".format(
                        text[0:submatch["start"]],
                        Color.GREEN,
                        submatch["match"]["text"],
                        Color.RESET,
                        text[submatch["end"]:]
                )
            line_width = max(len(str(d["line_number"])), line_width)

            matches.append(SearchMatch(
                hint="".join(hints[i]),
                line_nr=d["line_number"],
                text=truncate(text),
                file_name=d["path"]["text"]
            ))
            i += 1

        elif j.get("type") == "context":
            matches.append(SearchMatch(
                line_nr=j["data"]["line_number"],
                text=truncate(j["data"]["lines"]["text"]),
                file_name=""
            ))

        elif j.get("type") == "end":
            with open(OUT_FILE, "a") as fd:
                for m in matches:
                    if m.hint:
                        # show normal match
                        fd.write("{}:{}:{}\n".format(
                            m.hint, m.line_nr, Path(m.file_name).absolute()
                        ))
                        print("{}{}{} {}{}{} {}".format(
                            Color.YELLOW,
                            m.hint,
                            Color.RESET,
                            Color.DIM,
                            str(m.line_nr).ljust(line_width),
                            Color.RESET,
                            m.text.rstrip())
                        )
                    else:
                        # context match - do not show "i"
                        print("{} {}{}{} {}".format(
                            " " * len(str(m.hint)),
                            Color.DIM,
                            str(m.line_nr).ljust(line_width),
                            Color.RESET,
                            m.text.rstrip())
                        )



    if process.stderr:
        print()
        print("{}{}{}".format(
            Color.RED,
            process.stderr,
            Color.RESET
        ))

    sys.exit(process.returncode)


if __name__ == "__main__":
    main()
